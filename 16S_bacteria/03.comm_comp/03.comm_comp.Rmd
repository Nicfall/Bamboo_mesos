---
title: "Bamboo mesos bacterial community compositions"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
 rmarkdown::html_document:
    theme: cerulean
    toc: yes
    toc_float: yes
    highlight: haddock
    number_sections: true
editor_options: 
  chunk_output_type: console
---

# Setup

## Libs

```{r}
library(ggplot2)
library(phyloseq)
library(cowplot)
#install.packages("colorBlindness")
library(colorBlindness)
library("microshades")
library("speedyseq")
library("ggpubr")
```

## Dater

```{r}
setwd("~/nicolagk@hawaii.edu - Google Drive/My Drive/Bamboo_mesos/Bamboo_mesos/16S_bacteria/03.comm_comp")

ps.clean <- readRDS("../01.process_asvs/bamboomesos_ps.lulu.clean.decontam.rds")
#ps.clean <- readRDS("../01.process_asvs/bamboomesos_ps.lulu.clean.decontam.rare11k.rds")
ps.clean

##newest iteration
ps.clean.exp1 <- subset_samples(ps.clean,Mesocosm_type=="Experiment")
ps.clean.exp2 <- subset_samples(ps.clean.exp1,Exp_day!=20)
ps.clean.exp3 <- subset_samples(ps.clean.exp2,Microbe_treatment!="AHK")
ps.clean.exp <- prune_taxa(taxa_sums(ps.clean.exp3) > 0, ps.clean.exp3)
ps.clean.exp #257 taxa, 100 samples
```

# Check where microbes came from 

```{r}
##quick check
custom.tax <- data.frame(ps.clean.exp@tax_table)
source <- c(custom.tax$likely_source)
custom.tax2 <- cbind(source,custom.tax[,1:9])
custom.tax$likely_source==custom.tax2$source
##make a copy before overwriting
ps.custom <- ps.clean.exp
ps.custom@tax_table <- tax_table(as.matrix(custom.tax2))

ps.custom.sourceglom <- tax_glom(ps.custom,"source")
ps.custom.sourceglom
ps.custom.sourceglom.rel <- transform_sample_counts(ps.custom.sourceglom, function(x) x / sum(x))

plot_bar(ps.custom.sourceglom.rel,fill="source")+
  theme_cowplot()+
  facet_wrap(Sample_type~Microbe_treatment,scales="free")+
  scale_fill_manual(values=c("#84D1B5","#CDF0B7","#7D0112","grey80","#C6A947","#0085A6","grey50","white"))+
  theme(axis.text.x=element_text(angle=45,hjust=1))

##taking out the data so I can plot it myself
psmelt.sourceglom.rel <- psmelt(ps.custom.sourceglom.rel)

psmelt.sourceglom.rel$source <- factor(psmelt.sourceglom.rel$source, levels = c("LAB", "MOS", "MOS/ENV", "ENV", "ENV/HFlarvae", "Lab_water", "unclear", "Wolbachia"))

ggplot(psmelt.sourceglom.rel, aes(x = Sample, y = Abundance, fill = source)) +
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_wrap(Microbe_treatment*Food_type ~ Sample_type, scales = "free") +
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

##E. coli
psmelt.eco <- subset(psmelt.sourceglom.rel,Microbe_treatment=="ECO")
psmelt.eco.bam <- subset(psmelt.eco,Food_type=="Bamboo")
psmelt.eco.sta <- subset(psmelt.eco,Food_type=="Larval food")

ggbar.eco.bam <- ggplot(psmelt.eco.bam,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank())+
  ylab("Rel. abundance")
ggbar.eco.bam

ggbar.eco.sta <- ggplot(psmelt.eco.sta,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank())+
  ylab("Rel. abundance")

##mosquito microbes
psmelt.mmo <- subset(psmelt.sourceglom.rel,Microbe_treatment=="MMO")
psmelt.mmo.bam <- subset(psmelt.mmo,Food_type=="Bamboo")
psmelt.mmo.sta <- subset(psmelt.mmo,Food_type=="Larval food")

ggbar.mmo.bam <- ggplot(psmelt.mmo.bam,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.mmo.bam

ggbar.mmo.sta <- ggplot(psmelt.mmo.sta,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.mmo.sta

##env microbes
psmelt.emo <- subset(psmelt.sourceglom.rel,Microbe_treatment=="EMO")
psmelt.emo.bam <- subset(psmelt.emo,Food_type=="Bamboo")
psmelt.emo.sta <- subset(psmelt.emo,Food_type=="Larval food")

ggbar.emo.bam <- ggplot(psmelt.emo.bam,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.emo.bam

ggbar.emo.sta <- ggplot(psmelt.emo.sta,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.emo.sta

##env + mos
psmelt.mem <- subset(psmelt.sourceglom.rel,Microbe_treatment=="MEM")
psmelt.mem.bam <- subset(psmelt.mem,Food_type=="Bamboo")
psmelt.mem.sta <- subset(psmelt.mem,Food_type=="Larval food")

ggbar.mem.bam <- ggplot(psmelt.mem.bam,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.mem.bam

ggbar.mem.sta <- ggplot(psmelt.mem.sta,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())+
  ylab("Relative abundance")
ggbar.mem.sta

##all
psmelt.all <- subset(psmelt.sourceglom.rel,Microbe_treatment=="ALL")
psmelt.all.bam <- subset(psmelt.all,Food_type=="Bamboo")
psmelt.all.sta <- subset(psmelt.all,Food_type=="Larval food")

ggbar.all.bam <- ggplot(psmelt.all.bam,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())
ggbar.all.bam

ggbar.all.sta <- ggplot(psmelt.all.sta,aes(x=Mesocosm_id,y=Abundance,fill=source))+
  geom_bar(stat = "identity", position = "stack") +
  theme_cowplot() +
  facet_grid(~Sample_type,scales="free")+
  #facet_grid(Food_type~Sample_type,scales="free")+
  scale_fill_manual(values = c("#7D0112","#C6A947","#0085A6","#84D1B5","#CDF0B7", "grey80", "grey50", "black"),name="Likely source") +
  theme(axis.text.x = element_blank(),axis.title.x = element_blank(),axis.ticks.x = element_blank(),axis.title.y=element_blank())+
  ylab("Relative abundance")
ggbar.all.sta

ggarrange(ggbar.eco.sta,ggbar.mmo.sta,ggbar.emo.sta,ggbar.mem.sta,ggbar.all.sta,ggbar.eco.bam,ggbar.mmo.bam,ggbar.emo.bam,ggbar.mem.bam,ggbar.all.bam,nrow=2,ncol=5,common.legend=T,legend="right",align="hv",labels=c("(a)","(b)","(c)","(d)","(e)","(f)","(g)","(h)","(i)","(j)"))

#ggsave("barplot.sources.pdf",width=13,height=4)
#ggsave("barplot.sources.png",width=13,height=4)
```

## Some E. coli stuff looks weird

```{r}
ps.lar.bam.eco1 <- subset_samples(ps.clean.exp,Microbe_treatment=="ECO" & Food_type=="Bamboo")
ps.lar.bam.eco1
ps.lar.bam.eco <- prune_taxa(taxa_sums(ps.lar.bam.eco1)!=0,ps.lar.bam.eco1)
ps.lar.bam.eco

plot_bar(ps.lar.bam.eco,fill="Genus")

ps.meth1 <- subset_taxa(ps.clean.exp,Genus=="Methylobacterium-Methylorubrum")
ps.meth <- prune_samples(sample_sums(ps.meth1)!=0,ps.meth1)
ps.meth
plot_bar(ps.meth,fill="id")+
  facet_wrap(~Microbe_treatment,scales="free")
```

# NMDS

## All

```{r}
ord.exp.nmds.horn <- ordinate(ps.clean.exp, "NMDS", "horn")

ord.exp.nmds.horn[["stress"]] #0.1501527

#colorz <- c("#30123B","#E1DD37","#3E9BFE","#4143A7","#AF1801")
#colorz <- c("#30123B","#AF1801","#22C5E2","#46F884","#E1DD37")

##unformatted
gg.exp.nmds.horn <- plot_ordination(ps.clean.exp, ord.exp.nmds.horn,color="Food_type",shape="Sample_type")+
  #stat_ellipse()+
  theme_cowplot()
gg.exp.nmds.horn

##extract data so I can make it look how I want
df.gg.exp.nmds.horn <- gg.exp.nmds.horn[["data"]]

df.gg.exp.nmds.horn$sample.food <- paste0(df.gg.exp.nmds.horn$Sample_type,"_",df.gg.exp.nmds.horn$Food_type)

##adding ordi spider?
#df.gg.exp.noahk.nmds.horn$Microbe_treatment <- factor(df.gg.exp.noahk.nmds.horn$Microbe_treatment,levels=c("ECO","MMO","EMO","MEM","ALL"))

df.gg.exp.nmds.horn$all.trts <- paste0(df.gg.exp.nmds.horn$sample.food,"_",df.gg.exp.nmds.horn$Microbe_treatment)

cent <- aggregate(cbind(NMDS1, NMDS2) ~ all.trts, data = df.gg.exp.nmds.horn, FUN = mean)

segs <- merge(df.gg.exp.nmds.horn, setNames(cent, c('all.trts','oNMDS1','oNMDS2')),by = 'all.trts', sort = FALSE)

##re-order
df.gg.exp.nmds.horn$Microbe_treatment <- factor(df.gg.exp.nmds.horn$Microbe_treatment,levels=c("ECO","MMO","EMO","MEM","ALL"))
df.gg.exp.nmds.horn$sample.food <- factor(df.gg.exp.nmds.horn$sample.food,levels=c("Larvae_Larval food","Larvae_Bamboo","Water_Larval food","Water_Bamboo"))

new.colors <- c("#7D0112","#C6A947","#84D1B5","#0085A6","#1F28A2")

new.plot <- ggplot(df.gg.exp.nmds.horn, aes(x=NMDS1, y=NMDS2,shape=sample.food,color=Microbe_treatment))+
  scale_shape_manual(values=c(17,15,24,22),name="Sample type - diet",labels=c("Larvae - bamboo","Larvae - standard","Water - bamboo","Water - standard"))+
  theme_cowplot()+
  geom_segment(data=segs, mapping = aes(xend = oNMDS1, yend = oNMDS2),alpha=0.5)+ # spiders
  geom_point(size=2,fill="white")+
  scale_color_manual(values=new.colors,name="Microbes",labels=c("Lab","Mos.","Env.","Mos.+Env.","Mos.+Env.+Lab"))+
  annotate("text",x=-1.8,y=-1.9,label="2D stress = 0.15")
new.plot

#ggsave("nmds.horn.exp.pdf",width=5.5,height=3.5)

#cvdPlot(new.plot)

##"final" iteration?

new.colors <- c("#7D0112","#C6A947","#84D1B5","#0085A6","#1F28A2")

#segs$Microbe_treatment <- factor(segs$Microbe_treatment,levels=c("ECO","MMO","EMO","MEM","ALL"))
##reorder
#df.gg.exp.nmds.horn$sample.food <- factor(df.gg.exp.nmds.horn$sample.food,levels=c("Larvae_Bamboo","Larvae_Larval food","Water_Bamboo","Water_Larval food"))

##switching the filled in stuff
gg.nmds <- ggplot(df.gg.exp.nmds.horn, aes(x=NMDS1, y=NMDS2,shape=sample.food,color=Microbe_treatment))+
  #scale_shape_manual(values=c(24,17,22,15),name="Sample type - diet",labels=c("Larvae - bamboo","Larvae - standard","Water - bamboo","Water - standard"))+
  scale_shape_manual(values=c(17,24,15,22),name="Sample type - diet",labels=c("Larvae - standard","Larvae - bamboo","Water - standard","Water - bamboo"))+
  theme_cowplot()+
  geom_segment(data=segs, mapping = aes(xend = oNMDS1, yend = oNMDS2),alpha=0.5)+ # spiders
  geom_point(size=2,fill="white")+
  scale_color_manual(values=new.colors,name="Microbiota",labels=c("LAB","MOS","ENV","MOS+ENV","MOS+ENV+LAB"))+
  annotate("text",x=-1,y=-1.9,label="2D stress = 0.15")+
  theme(plot.margin = margin(b = 60,t=20))
gg.nmds

# gg.nmds.noleg <- ggplot(df.gg.exp.nmds.horn, aes(x=NMDS1, y=NMDS2,shape=sample.food,color=Microbe_treatment))+
#   scale_shape_manual(values=c(24,17,22,15),name="Sample type - diet",labels=c("Larvae - bamboo","Larvae - standard","Water - bamboo","Water - standard"))+
#   theme_cowplot()+
#   geom_segment(data=segs, mapping = aes(xend = oNMDS1, yend = oNMDS2),alpha=0.5)+ # spiders
#   geom_point(size=2,fill="white")+
#   scale_color_manual(values=new.colors,name="Microbiota",labels=c("LAB","MOS","ENV","MOS+ENV","MOS+ENV+LAB"))+
#   #guides(fill="none",color="none",shape="none")+
#   annotate("text",x=-1.8,y=-1.9,label="2D stress = 0.15")
#   #theme(plot.margin = margin(b = 60))
# gg.nmds.noleg
#ggsave("nmds.horn.exp.pdf",width=5.5,height=3.5)
```

## NMDS + diversity

```{r}
# gg.rich.nmds <- ggarrange(gg.richness.all,gg.nmds,ncol=2)
# gg.rich.nmds

gg.rich.nmds <- ggarrange(gg.richness.all,gg.nmds,ncol=2,widths=c(1,0.8),labels=c(" ","(c)"))
gg.rich.nmds
```

# Community compositions

## Sample types summed for plotting

```{r}
ps.expstock1 <- subset_samples(ps.clean,Mesocosm_type=="Experiment"|Mesocosm_type=="Microbe stock")
ps.expstock2 <- subset_samples(ps.expstock1,Exp_day!=20)
ps.expstock3 <- subset_samples(ps.expstock2,Microbe_treatment!="AHK")
ps.expstock <- prune_taxa(taxa_sums(ps.expstock3) > 0, ps.expstock3)
ps.expstock #298 taxa, 103 samples

##initial relative abundance per sample
ps.expstock.rel <- transform_sample_counts(ps.expstock, function(x) x / sum(x))

##make the variable to sum by
samdf.expstock <- data.frame(ps.expstock.rel@sam_data)
##just renaming some stuff
samdf.expstock$Microbe_treatment <- sub("E. coli","ECO",samdf.expstock$Microbe_treatment)
samdf.expstock$Microbe_treatment <- sub("Mosquito microbes","MMO",samdf.expstock$Microbe_treatment)
samdf.expstock$Microbe_treatment <- sub("Env. microbes","EMO",samdf.expstock$Microbe_treatment)
##start the summing
samdf.expstock$glom <- paste0(substr(samdf.expstock$Sample_type,1,5),"_",substr(samdf.expstock$Food_type,1,5),"_",samdf.expstock$Microbe_treatment)
samdf.expstock$glom
##replace the old sample data with the new one
ps.expstock.rel@sam_data <- sample_data(samdf.expstock)
##merge by the new variable "glom"
ps.expstock.rel.glom <- merge_samples(ps.expstock.rel, "glom")
##take relative abundance of the new sample type
ps.expstock.rel.glom.rel <- transform_sample_counts(ps.expstock.rel.glom, function(x) x / sum(x))

plot_bar(ps.expstock.rel.glom.rel,fill="Order")
```

## Top taxa calculations

Need this info for plotting

```{r}
##Who are the top taxa for microshades
# Merges ASVs that have the same taxonomy rank
ps.expstock.rel.glom.rel.taxglom <- tax_glom(ps.expstock.rel.glom.rel, taxrank = "Order") 
ps.expstock.rel.glom.rel.taxglom 

# Calculate taxa sum
top.phy = head(sort(colSums(otu_table(ps.expstock.rel.glom.rel.taxglom)), decreasing = TRUE), 15)
# Combine count and taxonomyTable
top.phy = cbind(as.data.frame(tax_table(ps.expstock.rel.glom.rel.taxglom)[names(top.phy),]), Count = top.phy)
top.phy
##PHYLA:
#Proteobacteria
#Bacteroidota
#Firmicutes
#Actinobacteriota
##ORDER:
#Enterobacterales
#Rhizobiales
#Pseudomonadales
#Burkholderiales
##CLASS:
#Gammaproteobacteria
#Alphaproteobacteria
#Bacteroidia
#Clostridia
##FAMILY:
#Yersiniaceae
#Beijerinckiaceae
#Moraxellaceae
#Sphingomonadaceae
#Chromobacteriaceae
#Kaistiaceae
#Comamonadaceae
#Enterobacteriaceae
#Sphingobacteriaceae
#Weeksellaceae
```

## Microshades plotting

```{r}
mdf.expstock <- prep_mdf(ps.expstock.rel.glom.rel,subgroup_level="Genus")

# Create a color object for the specified data
#col.mdf.expstock <- create_color_dfs(mdf.expstock, top_orientation = F,group_level="Phylum",subgroup_level="Genus",selected_groups=c("Proteobacteria","Bacteroidota","Firmicutes","Actinobacteriota"),cvd=TRUE)
#col.mdf.expstock <- create_color_dfs(mdf.expstock, top_orientation = F,group_level="Class",subgroup_level="Genus",selected_groups=c("Gammaproteobacteria","Alphaproteobacteria","Bacteroidia","Clostridia"),cvd=TRUE)
col.mdf.expstock <- create_color_dfs(mdf.expstock, top_orientation = F,group_level="Order",subgroup_level="Genus",selected_groups=c("Enterobacterales","Rhizobiales","Burkholderiales","Pseudomonadales"),cvd=TRUE)
# col.mdf.expstock <- create_color_dfs(mdf.expstock, top_orientation = F,group_level="Family",subgroup_level="Genus",selected_groups=c("Yersiniaceae","Beijerinckiaceae","Sphingomonadaceae","Moraxellaceae"),cvd=TRUE)
#Yersiniaceae
#Beijerinckiaceae
#Moraxellaceae
#Sphingomonadaceae
#Extract
col.mdf.expstock.m <- col.mdf.expstock$mdf
col.mdf.expstock.c <- col.mdf.expstock$cdf

##only the sample names were retained during the sample_glom stuff, so have to make new metadata
col.mdf.expstock.m$Sample_type <- substr(col.mdf.expstock.m$Sample,1,5)
col.mdf.expstock.m$Sample_type
col.mdf.expstock.m$Food_type <- substr(col.mdf.expstock.m$Sample,7,11)
col.mdf.expstock.m$Food_type
col.mdf.expstock.m$Microbe_treatment <- substr(col.mdf.expstock.m$Sample,13,16)
col.mdf.expstock.m$Microbe_treatment

##reorder for plotting
col.mdf.expstock.m$Microbe_treatment <- factor(col.mdf.expstock.m$Microbe_treatment,levels=c("ECO","EMO","MMO","MEM","ALL"))

##default plot
plot_microshades(col.mdf.expstock.m, col.mdf.expstock.c)+
  facet_grid(.~Microbe_treatment,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  #scale_x_discrete(labels=c("LAB","MOS","ENV"))+
  #theme(axis.text.x=element_blank())+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  #xlab("Microbe stock")+
  ylab("Relative abundance")+
  #ggtitle("Mosquitoes")+
  guides(color=guide_legend("Class-Genus"),fill=guide_legend("Class-Genus"))

##reassign colors
col.mdf.expstock.c.new <- color_reassign(col.mdf.expstock.c,
                          group_assignment = c("Enterobacterales","Rhizobiales","Burkholderiales","Pseudomonadales"),
                          color_assignment = c("micro_cvd_purple","micro_cvd_orange","micro_cvd_blue","micro_cvd_green"),group_level="Order")

##removing a bunch that aren't visible
df_tmp <- as.data.frame(col.mdf.expstock.m)
df_tmp$group <- as.character(df_tmp$group)

aggregate(Abundance ~ group, data = df_tmp, FUN = sum)

##replace pseus in the m data
col.mdf.expstock.m$group <- gsub("Pseudomonadales-Pseudomonas","Pseudomonadales-Other",col.mdf.expstock.m$group)
col.mdf.expstock.m$group <- gsub("Pseudomonadales-Alkanindiges","Pseudomonadales-Other",col.mdf.expstock.m$group)
col.mdf.expstock.m$group <- gsub("Pseudomonadales-Cavicella","Pseudomonadales-Other",col.mdf.expstock.m$group)
# col.mdf.expstock.m$group <- gsub("Pseudomonadales-Other","Other-Other",col.mdf.expstock.m$group)
##replace pseus in the c data
col.mdf.expstock.c.new$group <- gsub("Pseudomonadales-Pseudomonas","Pseudomonadales-Other",col.mdf.expstock.c.new$group)
col.mdf.expstock.c.new$group <- gsub("Pseudomonadales-Alkanindiges","Pseudomonadales-Other",col.mdf.expstock.c.new$group)
col.mdf.expstock.c.new$group <- gsub("Pseudomonadales-Cavicella","Pseudomonadales-Other",col.mdf.expstock.c.new$group)
# col.mdf.expstock.c.new$group <- gsub("Pseudomonadales-Other","Other-Other",col.mdf.expstock.c.new$group)

dput(as.character(unique(col.mdf.expstock.c.new$group)))

##desired order of legend
desired.order <- c("Enterobacterales-Serratia", "Enterobacterales-Escherichia-Shigella","Enterobacterales-Yersinia", 
"Enterobacterales-Order_Enterobacterales",  
"Enterobacterales-Other", "Pseudomonadales-Acinetobacter","Pseudomonadales-Other", "Burkholderiales-Aquitalea", 
"Burkholderiales-Curvibacter", "Burkholderiales-Comamonas", "Burkholderiales-Family_Comamonadaceae", 
"Burkholderiales-Other", "Rhizobiales-Rhodoblastus", "Rhizobiales-Kaistia", 
"Rhizobiales-Methylobacterium-Methylorubrum", "Rhizobiales-Roseiarcus", 
"Rhizobiales-Other", "Other-Sphingomonas", "Other-Novosphingobium", 
"Other-Chryseobacterium", "Other-Sphingobacterium", "Other-Other"
)

col.mdf.expstock.c.new$group <- factor(col.mdf.expstock.c.new$group, levels = desired.order)

desired.order.plot <- rev(c("Enterobacterales-Serratia", "Enterobacterales-Escherichia-Shigella","Enterobacterales-Yersinia", 
"Enterobacterales-Order_Enterobacterales",  
"Enterobacterales-Other", "Pseudomonadales-Acinetobacter","Pseudomonadales-Other", "Burkholderiales-Aquitalea", 
"Burkholderiales-Curvibacter", "Burkholderiales-Comamonas", "Burkholderiales-Family_Comamonadaceae", 
"Burkholderiales-Other", "Rhizobiales-Rhodoblastus", "Rhizobiales-Kaistia", 
"Rhizobiales-Methylobacterium-Methylorubrum", "Rhizobiales-Roseiarcus", 
"Rhizobiales-Other", "Other-Sphingomonas", "Other-Novosphingobium", 
"Other-Chryseobacterium", "Other-Sphingobacterium", "Other-Other"
))

col.mdf.expstock.m$group <- factor(col.mdf.expstock.m$group, levels = desired.order.plot)

##replace missing colors
#col.mdf.expstock.c.new$hex <- gsub("#6D9F06","#F5F5F5",col.mdf.expstock.c.new$hex)

plot_microshades(col.mdf.expstock.m, col.mdf.expstock.c.new)+
  facet_grid(.~Microbe_treatment+Food_type,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  #scale_x_discrete(labels=c("LAB","MOS","ENV"))+
  #theme(axis.text.x=element_blank())+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  #xlab("Microbe stock")+
  ylab("Relative abundance")+
  #ggtitle("Mosquitoes")+
  guides(color=guide_legend("Class-Genus"),fill=guide_legend("Class-Genus"))+
  scale_fill_manual(
  values = setNames(col.mdf.expstock.c.new$hex, col.mdf.expstock.c.new$group),
  breaks = desired.order)+
  scale_color_manual(
  values = setNames(col.mdf.expstock.c.new$hex, col.mdf.expstock.c.new$group),
  breaks = desired.order)

##changing more colors
library(dplyr)

# Get the hex codes you want to swap
hex2 <- "#A1527F" 
hex3 <- "#CC79A7"  
hex4 <- "#E794C1" 

col.mdf.expstock.c.new.edits <- col.mdf.expstock.c.new %>%
  mutate(hex = case_when(
    group == "Enterobacterales-Escherichia-Shigella" ~ hex2,
    group == "Enterobacterales-Yersinia" ~ hex3,
    group == "Enterobacterales-Order_Enterobacterales" ~ hex4,
    group == "Pseudomonadales-Other" ~ "#BDEC6F",
    TRUE ~ hex
  ))

plot_microshades(col.mdf.expstock.m, col.mdf.expstock.c.new.edits)+
  facet_grid(.~Microbe_treatment+Food_type,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  #scale_x_discrete(labels=c("LAB","MOS","ENV"))+
  #theme(axis.text.x=element_blank())+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  #xlab("Microbe stock")+
  ylab("Relative abundance")+
  #ggtitle("Mosquitoes")+
  guides(color=guide_legend("Class-Genus"),fill=guide_legend("Class-Genus"))+
  scale_fill_manual(
  values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
  breaks = desired.order)+
  scale_color_manual(
  values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
  breaks = desired.order)
```

## "Final" plots

```{r}
##renaming the microbes
col.mdf.expstock.m$Microbe_treatment <- gsub("ECO","LAB",col.mdf.expstock.m$Microbe_treatment)
col.mdf.expstock.m$Microbe_treatment <- gsub("MMO","MOS",col.mdf.expstock.m$Microbe_treatment)
col.mdf.expstock.m$Microbe_treatment <- gsub("EMO","ENV",col.mdf.expstock.m$Microbe_treatment)
col.mdf.expstock.m$Microbe_treatment <- gsub("MEM","M+E",col.mdf.expstock.m$Microbe_treatment)
col.mdf.expstock.m$Microbe_treatment <- gsub("ALL","M+E+L",col.mdf.expstock.m$Microbe_treatment)
#col.mdf.expstock.m$Microbe_treatment <- gsub("ALL","MOS+ENV+LAB",col.mdf.expstock.m$Microbe_treatment)

col.mdf.expstock.m$Microbe_treatment <- factor(col.mdf.expstock.m$Microbe_treatment,levels=c("LAB","MOS","ENV","M+E","M+E+L"))

#col.mdf.expstock.m$Food_type <- factor(col.mdf.expstock.m$Food_type,levels=c("Larva","Bambo"))
#have to make sample names alphabetical for plotting
col.mdf.expstock.m$Sample <- sub("Bambo","zBambo",col.mdf.expstock.m$Sample)
```

### Larvae

```{r}
col.mdf.larv <- subset(col.mdf.expstock.m,Sample_type=="Larva")

ms.larv <- plot_microshades(col.mdf.larv, col.mdf.expstock.c.new.edits)+
  facet_grid(.~Microbe_treatment,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  scale_x_discrete(labels=rep(c("Standard","Bamboo",5)))+
  #theme(axis.text.x=element_blank())+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1),legend.position="none")+
  ggtitle("Larvae samples")+
  xlab("Diet")+
  ylab("Relative abundance")
  # #ggtitle("Mosquitoes")+
  # guides(color=guide_legend("Class-Genus"),fill=guide_legend("Class-Genus"))+
  # scale_fill_manual(
  # values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
  # breaks = desired.order)+
  # scale_color_manual(
  # values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
  # breaks = desired.order)+
ms.larv
```

### Water

```{r}
col.mdf.water <- subset(col.mdf.expstock.m,Sample_type=="Water")

ms.water <- plot_microshades(col.mdf.water, col.mdf.expstock.c.new.edits)+
  facet_grid(.~Microbe_treatment,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  scale_x_discrete(labels=rep(c("Standard","Bamboo",5)))+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1),axis.text.y=element_blank(),legend.position="none")+
  ylab("")+
  xlab("Diet")+
  ggtitle("Water samples")
# 
#   guides(color=guide_legend("Class-Genus"),fill=guide_legend("Class-Genus"))+
#   scale_fill_manual(
#   values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
#   breaks = desired.order)+
#   scale_color_manual(
#   values = setNames(col.mdf.expstock.c.new.edits$hex, col.mdf.expstock.c.new.edits$group),
#   breaks = desired.order)+

ms.water
```

### Inocula stocks

```{r}
col.mdf.stox <- subset(col.mdf.expstock.m,Sample_type=="Micro")

##reorder
col.mdf.stox$Sample <- factor(col.mdf.stox$Sample,levels=c("Micro_Micro_ECO","Micro_Micro_MMO","Micro_Micro_EMO"))

ms.stox <- plot_microshades(col.mdf.stox, col.mdf.expstock.c.new.edits)+
  #facet_grid(.~Microbe_treatment,scales="free")+
  theme_cowplot()+
  #facet_wrap(~Sample_type*Microbe_treatment,scales="free",nrow=1)+
  scale_x_discrete(labels=c("LAB","MOS","ENV"))+
  #theme(axis.text.x=element_blank())+
  theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1),legend.position="none",plot.margin = margin(t=20,b = 20))+
  ylab("Relative abundance")+
  ggtitle("Inocula")+
  xlab("")
ms.stox
```

### All together

```{r}
#col.mdf.expstock.m$Top_Order <- factor(col.mdf.expstock.m$Top_Order,levels=c("Enterobacterales","Pseudomonadales","Burkholderiales","Rhizobiales","Other"))
#col.mdf.expstock.m$Order <- factor(col.mdf.expstock.m$Order,levels=c("Enterobacterales","Pseudomonadales","Burkholderiales","Rhizobiales","Other"))
col.mdf.expstock.c.new.edits$Top_Order <- factor(col.mdf.expstock.c.new.edits$Top_Order,levels=c("Enterobacterales","Pseudomonadales","Burkholderiales","Rhizobiales","Other"))

col.mdf.expstock.c.new.edits$Top_Genus <- gsub("Cavicella","test", col.mdf.expstock.c.new.edits$Top_Genus) 
col.mdf.expstock.c.new.edits$Top_Genus <- gsub("Pseudomonas", "test", col.mdf.expstock.c.new.edits$Top_Genus)
col.mdf.expstock.c.new.edits$Top_Genus <- gsub("Alkanindiges", "test", col.mdf.expstock.c.new.edits$Top_Genus)

# dput(col.mdf.expstock.c.new.edits$Top_Genus)
# col.mdf.expstock.c.new.edits$Top_Genus <- factor(col.mdf.expstock.c.new.edits$Top_Genus,levels=c("Acinetobacter", "pseu1", "pseu2", "pseu3", "Other", 
# "Aquitalea", "Curvibacter", "Comamonas", "Family_Comamonadaceae", 
# "Other", "Rhodoblastus", "Kaistia", "Methylobacterium-Methylorubrum", 
# "Roseiarcus", "Other", "Serratia","Escherichia-Shigella", "Yersinia", "Order_Enterobacterales", 
# "Other", "Sphingomonas", "Novosphingobium", 
# "Chryseobacterium", "Sphingobacterium", "Other"))

df <- col.mdf.expstock.c.new.edits

# Your data frame (replace with your actual df name)
df <- col.mdf.expstock.c.new.edits

# Find target row
target_row <- which(df$Top_Genus == "Escherichia-Shigella")

# Calculate new position (don't go below 1)
new_position <- max(1, target_row - 2)

# Extract the target row
target_data <- df[target_row, ]

# Remove the target row from df
df_without_target <- df[-target_row, ]

# Split df_without_target into two parts: before and after new_position
df_before <- df_without_target[1:(new_position - 1), ]
df_after <- df_without_target[new_position:nrow(df_without_target), ]

# Recombine: rows before new position + target row + rows after
df_new <- rbind(df_before, target_data, df_after)

# Check new order
df_new$Top_Genus
                # combine into new data frame

legend_1 <- custom_legend(col.mdf.expstock.m, df_new,group_level="Order",subgroup_level="Genus",legend_key_size = 1, legend_text_size = 13,legend_orientation = "horizontal")
legend_1
#"#BDEC6F"

ms.all3 <- ggarrange(ms.stox,ms.larv,ms.water,ncol=3,legend="none",widths=c(0.4,1,1),labels=c("(d)","(e)","(f)"))

# # output the plot and custom legend
#plot_grid(ms.all3, legend_1, rel_widths=c(3,1))  
gg.barplots.all <- plot_grid(ms.all3, legend_1, nrow=2,rel_heights=c(1,0.25)) 
gg.barplots.all
```

### Now with diversity and nmds

```{r}
#ggarrange(gg.richness.all, gg.nmds, gg.barplots.all, nrow=3)

bac.massive <- ggarrange(gg.rich.nmds,ms.all3,nrow=2,heights=c(1,0.9))
bac.massive
#ggsave("gg.massivebacfig.png",height=7.1,width=10)

plot_grid(bac.massive, legend_1, nrow=2,rel_heights=c(1,0.2)) 
#ggsave("gg.massivebacfig.png",height=8.4,width=10)

```

# Microbe stocks bar plot

## Setup

```{r}
library("microshades")
#remotes::install_github("mikemc/speedyseq")
library("speedyseq")
```

## Prep

```{r}
ps.stocks1 <- subset_samples(ps.clean,Mesocosm_type=="Microbe stock")
ps.stocks <- prune_taxa(taxa_sums(ps.stocks1) > 0, ps.stocks1)
ps.stocks

ps.stocks.rel <- transform_sample_counts(ps.stocks, function(x) x / sum(x))

plot_bar(ps.stocks.rel,fill="Order")
```

## Top phyla prep

```{r}
##Who are the top taxa for microshades
# Merges ASVs that have the same taxonomy rank
## Phylum ##
ps.stocks.rel.phy <- tax_glom(ps.stocks.rel, taxrank = "Class") 
ps.stocks.rel.phy #8 total

# Calculate taxa sum
top5 = head(sort(colSums(otu_table(ps.stocks.rel.phy)), decreasing = TRUE), 10)
# Combine count and taxonomyTable
top5 = cbind(as.data.frame(tax_table(ps.stocks.rel.phy)[names(top5),]), Count = top5)
top5
#Proteobacteria
#Firmicutes
#Acidobacteriota
#Bacteroidota

##Gammaprot
##Alphaprot
##Bacilli
#Negativ
```

## Phyla microshades plotting 

```{r}
mdf.stocks <- prep_mdf(ps.stocks.rel,subgroup_level="Genus")

# Create a color object for the specified data
#col.mdf.stocks <- create_color_dfs(mdf.stocks, top_orientation = F,group_level="Phylum",subgroup_level="Genus",selected_groups=c("Proteobacteria","Firmicutes","Acidobacteriota","Bacteroidota"),cvd=TRUE)
# col.mdf.stocks <- create_color_dfs(mdf.stocks, top_orientation = F,group_level="Class",subgroup_level="Genus",selected_groups=c("Gammaproteobacteria","Alphaproteobacteria","Bacilli","Negativicutes"),cvd=TRUE)
col.mdf.stocks <- create_color_dfs(mdf.stocks, top_orientation = F,group_level="Order",subgroup_level="Genus",selected_groups=c("Enterobacterales","Rhizobiales","Burkholderiales","Pseudomonadales"),cvd=TRUE)

#Extract
col.mdf.stocks.m <- col.mdf.stocks$mdf
col.mdf.stocks.c <- col.mdf.stocks$cdf

##default plot
plot_microshades(col.mdf.stocks.m, col.mdf.stocks.c)+
  #facet_wrap(scales="free")+
  theme_cowplot()+
  #facet_wrap(~infusion,scales="free")+
  scale_x_discrete(labels=c("E.coli","Mosq.","Env."))+
  #theme(axis.text.x=element_text(angle=45,vjust=1,hjust=1))+
  xlab("Microbe stock")+
  #ggtitle("Mosquitoes")+
  guides(color=guide_legend("Phylum-Family"),fill=guide_legend("Phylum-Family"))
```



## Just larvae first

```{r}
col.mdf.expstock.m
col.mdf.expstock.c.new

col.mdf.larv <- subset(col.mdf.expstock.m,Sample_type=="Larva")

plot_microshades(col.mdf.larv,col.mdf.expstock.c.new)+
  facet_grid(.~Microbe_treatment,scales="free_x")

col.mdf.wat <- subset(col.mdf.expstock.m,Sample_type=="Water")

##default plot
plot <- plot_microshades(col.mdf.wat,col.mdf.expstock.c.new)+
  facet_grid(.~Microbe_treatment,scales="free_x")+
  theme_cowplot()+
  theme(axis.text.x=element_text(angle=45,hjust=1))

# create the custom legend
legend_1 <- custom_legend(col.mdf.wat, col.mdf.expstock.c.new,group_level="Order",subgroup_level="Genus")  

# plot using the custom legend 
plot_1 <- plot +
  theme(legend.position="none") # removes the original legend.
  #facet_wrap(~Sample_Type, scales="free_x", nrow=2)

# output the plot and custom legend
plot_grid(plot_1, legend_1)  


```

# Alluvium plot

Just for some light torture

```{r}
#install.packages("ggalluvial")
library("ggalluvial")

##y axis = relative abundance
##x axis = microbe treatment
##starting with just EMO, MMO, and MEM in bamboo to practice

ps.exp.mem1 <- subset_samples(ps.clean,Mesocosm_type=="Experiment")
ps.exp.mem2 <- subset_samples(ps.exp.mem1,Exp_day!=20)
ps.exp.mem3 <- subset_samples(ps.exp.mem2,Microbe_treatment!="AHK"&Microbe_treatment!="ALL"&Microbe_treatment!="ECO")
ps.exp.mem.bam1 <- subset_samples(ps.exp.mem3,Food_type=="Bamboo")
ps.mem.bam.lar1 <- subset_samples(ps.exp.mem.bam1,Sample_type=="Larvae")
ps.mem.bam.lar <- prune_taxa(taxa_sums(ps.mem.bam.lar1) > 0, ps.mem.bam.lar1)
ps.mem.bam.lar #109 taxa, 15 samples

##initial relative abundance per sample
ps.mem.bam.lar.rel <- transform_sample_counts(ps.mem.bam.lar, function(x) x / sum(x))

# ##make the variable to glom by
#samdf.mem.bam.lar <- data.frame(ps.mem.bam.lar@sam_data)
# samdf.expstock$Microbe_treatment <- sub("E. coli","ECO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Microbe_treatment <- sub("Mosquito microbes","MMO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Microbe_treatment <- sub("Env. microbes","EMO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Sample_type <- sub("Microbe Stock","aMicro",samdf.expstock$Sample_type)
# samdf.expstock$glom <- paste0(substr(samdf.expstock$Sample_type,1,5),"_",substr(samdf.expstock$Food_type,1,5),"_",samdf.expstock$Microbe_treatment)
##changing the order:
# samdf.expstock$glomvar <- paste0(substr(samdf.mem.bam.lar$Sample_type,1,5),"_",substr(samdf.expstock$Food_type,1,5),"_",)
# samdf.expstock$glom
# ps.expstock.rel@sam_data <- sample_data(samdf.expstock)

ps.mem.bam.lar.rel.glom <- merge_samples(ps.mem.bam.lar.rel, "Microbe_treatment")
ps.mem.bam.lar.rel.glom.rel <- transform_sample_counts(ps.mem.bam.lar.rel.glom, function(x) x / sum(x))

plot_bar(ps.mem.bam.lar.rel.glom.rel,fill="Family")

ps.mem.bam.lar.rel.glom.rel.fam <- tax_glom(ps.mem.bam.lar.rel.glom.rel,"Family")
ps.mem.bam.lar.rel.glom.rel.fam@tax_table

psmelt.mem.bam.lar.fam <- psmelt(ps.mem.bam.lar.rel.glom.rel.fam)
str(psmelt.mem.bam.lar.fam)

#is_alluvia_form(psmelt.mem.bam.lar, weight = "Abundance")

ggplot(psmelt.mem.bam.lar.fam,aes(x=Sample, y=Abundance, stratum = Family, alluvium=Family, fill=Family, label=Family))+
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray")+
  geom_stratum(color=NA)+
  #facet_grid(temperature~.)+
  #scale_fill_manual(values=pal.all)+
  theme_bw()
```

# Stocks to samples?

```{r}
#y axis = relative abundance
##x axis = sample type
##starting with just EMO to practice

ps.emo1 <- subset_samples(ps.clean, Microbe_treatment=="EMO" | Microbe_treatment=="Env. microbes")
ps.emo2 <- subset_samples(ps.emo1,Exp_day!=20)
ps.emo2
ps.emo3 <- subset_samples(ps.emo2,Mesocosm_type!="Additional control")
table(ps.emo3@sam_data$Mesocosm_type)

ps.emo3@sam_data$food_sam <- paste0(ps.emo3@sam_data$Food_type,"_",ps.emo3@sam_data$Sample_type)

##initial relative abundance per sample
ps.emo.rel <- transform_sample_counts(ps.emo3, function(x) x / sum(x))

# ##make the variable to glom by
#samdf.mem.bam.lar <- data.frame(ps.mem.bam.lar@sam_data)
# samdf.expstock$Microbe_treatment <- sub("E. coli","ECO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Microbe_treatment <- sub("Mosquito microbes","MMO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Microbe_treatment <- sub("Env. microbes","EMO",samdf.expstock$Microbe_treatment)
# samdf.expstock$Sample_type <- sub("Microbe Stock","aMicro",samdf.expstock$Sample_type)
# samdf.expstock$glom <- paste0(substr(samdf.expstock$Sample_type,1,5),"_",substr(samdf.expstock$Food_type,1,5),"_",samdf.expstock$Microbe_treatment)
##changing the order:
# samdf.expstock$glomvar <- paste0(substr(samdf.mem.bam.lar$Sample_type,1,5),"_",substr(samdf.expstock$Food_type,1,5),"_",)
# samdf.expstock$glom
# ps.expstock.rel@sam_data <- sample_data(samdf.expstock)

ps.emo.rel.foodsamglom <- merge_samples(ps.emo.rel, "food_sam")
ps.emo.rel.foodsamglom.rel1 <- transform_sample_counts(ps.emo.rel.foodsamglom, function(x) x / sum(x))
ps.emo.rel.foodsamglom.rel <- prune_taxa(taxa_sums(ps.emo.rel.foodsamglom.rel1)!=0,ps.emo.rel.foodsamglom.rel1)
ps.emo.rel.foodsamglom.rel

plot_bar(ps.emo.rel.foodsamglom.rel,fill="Family")

ps.emo.rel.foodsamglom.rel.fam <- tax_glom(ps.emo.rel.foodsamglom.rel,"Family")
ps.emo.rel.foodsamglom.rel.fam@tax_table

psmelt.emo.rel.foodsamglom.rel.fam <- psmelt(ps.emo.rel.foodsamglom.rel.fam)
#str(psmelt.emo.rel.foodsamglom.rel.fam)

#is_alluvia_form(psmelt.mem.bam.lar, weight = "Abundance")

ggplot(psmelt.emo.rel.foodsamglom.rel.fam,aes(x=Sample, y=Abundance, stratum = Family, alluvium=Family, fill=Family, label=Family))+
  geom_flow(stat = "alluvium", lode.guidance = "frontback",
            color = "darkgray")+
  geom_stratum(color=NA)+
  #facet_grid(temperature~.)+
  #scale_fill_manual(values=pal.all)+
  theme_bw()
```

# Samples to check

- Hatching flask water
- Hatching flask eggs
- Hatching flask L1s
- Lab water 

```{r}
ps.base1 <- subset_samples(ps.clean,Mesocosm_treatment=="Hatch_flask"|Mesocosm_treatment=="Lab_water")

ps.base <- prune_taxa(taxa_sums(ps.base1)!=0,ps.base1)
ps.base

plot_bar(ps.base,fill="id",x="Longer_name")+
  facet_wrap(~Genus,scales="free")

ps.base@otu_table
##6 taxa of note to take with a grain of salt below:
##"ASV0002" "ASV0008" "ASV0018" "ASV0030" "ASV0227" "ASV0274"

ps.clean.basetax <- subset_taxa(ps.clean, taxa_names(ps.clean) %in% taxa_names(ps.base))

plot_bar(ps.clean.basetax,fill="id")+
  facet_wrap(Genus~Sample_type,scales="free")

ps.clean.wolb <- subset_taxa(ps.clean,Genus=="Wolbachia")
plot_bar(ps.clean.wolb)
```

# Euler diagram of shared ASVs

```{r}
#install.packages("remotes")
#remotes::install_github("Russel88/MicEco")
library("MicEco")
library("phyloseq")
library("ggplot2")
library("grid")
#install.packages("VennDiagram")
#library("VennDiagram")
#library(grDevices)
#library("stringr")

setwd("~/nicolagk@hawaii.edu - Google Drive/My Drive/Bamboo_mesos/Bamboo_mesos/03.comm_comp")
ps.clean <- readRDS("../01.process_asvs/bamboomesos_ps.lulu.clean.decontam.rds")
```

## Microbe stocks

```{r}
ps.stocks1 <- subset_samples(ps.clean,Mesocosm_type=="Microbe stock")
ps.stocks <- prune_taxa(taxa_sums(ps.stocks1) > 0, ps.stocks1)
ps.stocks

new.colors <- c("#7D0112","#C6A947","#84D1B5","#0085A6","#1F28A2")

##all
venn.stocks <- ps_venn(ps.stocks,group="Microbe_treatment",quantities=TRUE,main="ASVs per microbial stock",labels=c("Lab","Env.","Mos."),
         fills = list(fill = c("#7D0112", "#84D1B5","#C6A947"), alpha = 0.5))
grid.draw(venn.stocks)
dev.off()

#pdf(file="venn.stocks.pdf",width=3,height=3)
#png(file="venn.stocks.png",width=3,height=3)

ps_venn(ps.stocks,group="Microbe_treatment",plot=F)
##4 that are shared:
#$`Env. microbes__Mosquito microbes`
#[1] "ASV0006" "ASV0053" "ASV0149" "ASV0525"
#Rhodoblastus, Roseiarcus, Roseiarcus, Roseiarcus
```

## Experiment compared with stocks

```{r}
ps.expstock1 <- subset_samples(ps.clean,Mesocosm_type=="Experiment"|Mesocosm_type=="Microbe stock")
ps.expstock2 <- subset_samples(ps.expstock1,Exp_day!=20)
ps.expstock <- prune_taxa(taxa_sums(ps.expstock2) > 0, ps.expstock2)
ps.expstock
```

### Mosquito microbes

```{r}
ps.expstock.mos1 <- subset_samples(ps.expstock,Microbe_treatment=="Mosquito microbes"|Microbe_treatment=="MMO")
ps.expstock.mos1
ps.expstock.mos <- prune_taxa(taxa_sums(ps.expstock.mos1) > 0, ps.expstock.mos1)
ps.expstock.mos #114 taxa, 21 samples

ps_venn(ps.expstock.mos,group="Microbe_treatment")

#graphics.off()
#^had to run this twice after stupid venn pdf plotting stuff
ps_venn(ps.expstock.mos,group="Microbe_treatment",quantities=TRUE,main="Mosquito microbes",alpha = 0.5,labels=c("Experiment","Inoculum"),fill=c("#D83706","#D83706")) #all 114 plotted

##which ones are shared/not
venn.stock.mmo <- ps_venn(ps.expstock.mos,group="Microbe_treatment",quantities=TRUE,main="Mosquito microbes",alpha = 0.5,labels=c("Experiment","Inoculum"),fill=c("#D83706","#D83706"),plot=F) #all 114 plotted

plot_bar(ps.expstock.mos,fill="Genus")+
  facet_wrap(~Family,scales="free")

##found in the experiment but not the stock :/ 
taxa_to_keep.mmo <- venn.stock.mmo[["MMO"]]

ps.mmo.only <- prune_taxa(taxa_names(ps.expstock.mos) %in% taxa_to_keep.mmo, ps.expstock.mos)
ps.mmo.only
ps.mmo.only.no0 <- prune_samples(sample_sums(ps.mmo.only)!=0,ps.mmo.only)
ps.mmo.only.no0

plot_bar(ps.mmo.only.no0,fill="Genus")+
  facet_wrap(~Family,scales="free")
```

## Base taxa

```{r}
ps.mmo.nobasetax <- subset_taxa(ps.mmo.only.no0, !taxa_names(ps.mmo.only.no0) %in% taxa_names(ps.base))
plot_bar(ps.mmo.nobasetax,fill="Genus")

```

### Env. microbes

```{r}
##env microbes
ps.expstock.env1 <- subset_samples(ps.expstock2,Microbe_treatment=="Env. microbes"|Microbe_treatment=="EMO")
ps.expstock.env <- prune_taxa(taxa_sums(ps.expstock.env1) > 0, ps.expstock.env1)
ps.expstock.env #166 taxa

ps_euler(ps.expstock.env,group="Microbe_treatment",quantities=TRUE,main="Env. microbes",alpha = 0.5,fill=c("#D83706","#D83706")) #all 114 plotted
,labels=c("Experiment","Inoculum"))
```

### Treatments compared

#### Larvae

```{r}

ps.exp1 <- subset_samples(ps.expstock2,Microbe_treatment=="MMO"|Microbe_treatment=="EMO"|Microbe_treatment=="MEM")
ps.exp1
ps.exp <- prune_taxa(taxa_sums(ps.exp1) > 0, ps.exp1)
ps.exp #234 taxa

ps_euler(ps.exp,group="Microbe_treatment",quantities=TRUE)
,
                  fills = list(fill = c("black", "#3B9FFD","#3B9FFD","#4145AA","#D83706","#D83706"), alpha = 0.5))

new.colors <- c("gray60","#D83706","#3B9FFD","#4145AA","black")

ps_euler(ps.expstock,group="Microbe_treatment",quantities=TRUE)


```

## E. coli

```{r}
ps.stock.eco1 <- subset_samples(ps.stocks,Microbe_treatment=="E. coli")
ps.stock.eco <- prune_taxa(taxa_sums(ps.stock.eco1) > 0, ps.stock.eco1)

plot_bar(ps.stock.eco,fill="asv")
ps.stock.eco@otu_table

ps.stock.eco@tax_table
```

## Mosquito slurry

```{r}
ps.stock.mmo1 <- subset_samples(ps.stocks,Microbe_treatment=="Mosquito microbes")
ps.stock.mmo <- prune_taxa(taxa_sums(ps.stock.mmo1) > 0, ps.stock.mmo1)

##ASV1 blasts as Serratia, ASV30 blasts as E. coli
ps.stock.mmo.gen = tax_glom(ps.stock.mmo, "genus")
plot_bar(ps.stock.mmo, fill="asv")

ps.exp.mmo1 <- subset_samples(ps.clean.exp,Microbe_treatment=="MMO")
ps.exp.mmo <- prune_taxa(taxa_sums(ps.exp.mmo1) > 0, ps.exp.mmo1)
ps.exp.mmo

```

## Bromeliad water

```{r}
ps.stock.emo1 <- subset_samples(ps.stocks,Microbe_treatment=="Env. microbes")
ps.stock.emo <- prune_taxa(taxa_sums(ps.stock.emo1) > 0, ps.stock.emo1)

##ASV1 blasts as Serratia, ASV30 blasts as E. coli
#ps.stock.emo.gen = tax_glom(ps.stock.emo, "genus")
plot_bar(ps.stock.emo, fill="asv")
```

# Controls

```{r}
ps.water <- subset_samples(ps.clean,Sample_type=="Water")
ps.con1 <- subset_samples(ps.water,Microbe_treatment=="AHK"|Mesocosm_type=="Hatching flask"|Mesocosm_type=="Lab water")

ps.con <- prune_taxa(taxa_sums(ps.con1) > 0, ps.con1)

ps.con

plot_bar(ps.con,fill="genus")+
  facet_wrap(Microbe_treatment~Mesocosm_type,scales="free")
#plot_bar(ps.con,fill="asv")+
#  facet_wrap(Microbe_treatment~Mesocosm_type,scales="free")

ps.con@otu_table
ps.con@tax_table
```

ASV2 = Sphingomonas - dominates hatching flask & lab water & some mesocosms

# Treatments

## E. coli/Serratia mess

```{r}
ps.exp.asv1 <- subset_taxa(ps.clean.exp,asv=="asv1")

plot_bar(ps.exp.asv1,fill="Microbe_treatment",x="Microbe_treatment")+
  facet_wrap(Sample_type~Food_type,scale="free")+
  ggtitle("ASV1 - Serratia?")

ps.exp.asv30 <- subset_taxa(ps.clean.exp,asv=="asv30")

plot_bar(ps.exp.asv30,fill="Microbe_treatment",x="Microbe_treatment")+
  facet_wrap(Sample_type~Food_type,scales="free")+
  ggtitle("ASV30 - E. coli?")

##both
ps.exp.asv.sereco <- subset_taxa(ps.clean.exp,asv=="asv1"|asv=="asv30")

plot_bar(ps.exp.asv.sereco,fill="asv",x="Microbe_treatment")+
  facet_wrap(Sample_type~Food_type,scale="free")+
  ggtitle("ASV1-Serratia?; ASV30-E.coli?")
```


